From 7c64b2eaeded20965b789800b3c905beba68d1d3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20Est=C3=A9vez?= <daniel@destevez.net>
Date: Thu, 14 Dec 2023 18:00:00 +0100
Subject: [PATCH] add e200 maia sdr buildroot support

---
 board/e200/S50maia-httpd | 26 ++++++++++++++++++++++++++
 board/e200/S50maia-kmod  | 21 +++++++++++++++++++++
 board/e200/post-build.sh | 11 +++++++++++
 3 files changed, 58 insertions(+)
 create mode 100644 board/e200/S50maia-httpd
 create mode 100644 board/e200/S50maia-kmod

diff --git a/board/e200/S50maia-httpd b/board/e200/S50maia-httpd
new file mode 100644
index 0000000000..c67614d65f
--- /dev/null
+++ b/board/e200/S50maia-httpd
@@ -0,0 +1,26 @@
+#!/bin/sh
+
+case "$1" in
+  start)
+	echo -n "Starting maia-httpd: "
+        cd /root
+        start-stop-daemon -S -b -q -m -p /var/run/maia-httpd.pid -x /root/maia-httpd
+        cd - > /dev/null
+	[ $? = 0 ] && echo "OK" || echo "FAIL"
+	;;
+  stop)
+        echo -n "Stopping maia-httpd: "
+        start-stop-daemon -K -q -p /var/run/maia-httpd.pid 2>/dev/null
+        [ $? = 0 ] && echo "OK" || echo "FAIL"
+	;;
+  restart|reload)
+        $0 stop
+        sleep 1
+        $0 start
+	;;
+  *)
+	echo "Usage: $0 {start|stop|restart}"
+	exit 1
+esac
+
+exit $?
diff --git a/board/e200/S50maia-kmod b/board/e200/S50maia-kmod
new file mode 100644
index 0000000000..5610f4d77e
--- /dev/null
+++ b/board/e200/S50maia-kmod
@@ -0,0 +1,21 @@
+#!/bin/sh
+#
+# Load maia-sdr kernel module
+#
+
+case "$1" in
+  start)
+	echo -n "Loading maia-sdr.ko: "
+	insmod /lib/modules/maia-sdr.ko
+	[ $? = 0 ] && echo "OK" || echo "FAIL"
+	;;
+  stop)
+	;;
+  restart|reload)
+	;;
+  *)
+	echo "Usage: $0 {start|stop|restart}"
+	exit 1
+esac
+
+exit $?
diff --git a/board/e200/S60maia-httpd b/board/e200/S60maia-httpd
new file mode 100644
index 0000000000..c67614d65f
--- /dev/null
+++ b/board/e200/S60maia-httpd
@@ -0,0 +1,26 @@
+#!/bin/sh
+
+case "$1" in
+  start)
+	echo -n "Starting maia-httpd: "
+        cd /root
+        start-stop-daemon -S -b -q -m -p /var/run/maia-httpd.pid -x /root/maia-httpd
+        cd - > /dev/null
+	[ $? = 0 ] && echo "OK" || echo "FAIL"
+	;;
+  stop)
+        echo -n "Stopping maia-httpd: "
+        start-stop-daemon -K -q -p /var/run/maia-httpd.pid 2>/dev/null
+        [ $? = 0 ] && echo "OK" || echo "FAIL"
+	;;
+  restart|reload)
+        $0 stop
+        sleep 1
+        $0 start
+	;;
+  *)
+	echo "Usage: $0 {start|stop|restart}"
+	exit 1
+esac
+
+exit $?
diff --git a/board/e200/post-build.sh b/board/e200/post-build.sh
index 03021a4918..111e744b30 100755
--- a/board/e200/post-build.sh
+++ b/board/e200/post-build.sh
@@ -91,3 +91,14 @@ ln -sf ../../wpa_supplicant/ifupdown.sh ${TARGET_DIR}/etc/network/if-pre-up.d/wp
 ln -sf ../../wpa_supplicant/ifupdown.sh ${TARGET_DIR}/etc/network/if-post-down.d/wpasupplicant
 
 ln -sf device_reboot ${TARGET_DIR}/usr/sbin/pluto_reboot
+
+# Maia SDR specific files
+${INSTALL} -d ${TARGET_DIR}/lib/modules
+${INSTALL} -D -m 0644 ${BOARD_DIR}/maia-sdr.ko ${TARGET_DIR}/lib/modules/
+${INSTALL} -D -m 0755 ${BOARD_DIR}/S50maia-kmod ${TARGET_DIR}/etc/init.d/
+${INSTALL} -D -m 0755 ${BOARD_DIR}/S60maia-httpd ${TARGET_DIR}/etc/init.d/
+# TODO: do not install maia-httpd and maia-wasm to /root
+${INSTALL} -D -m 0755 ${BOARD_DIR}/maia-httpd ${TARGET_DIR}/root/
+${INSTALL} -D -m 0644 ${BOARD_DIR}/maia-wasm/assets/* ${TARGET_DIR}/root/
+${INSTALL} -d ${TARGET_DIR}/root/pkg
+${INSTALL} -D -m 0644 ${BOARD_DIR}/maia-wasm/pkg/* ${TARGET_DIR}/root/pkg/
-- 
2.43.0

